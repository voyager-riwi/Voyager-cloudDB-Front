- name: Deploy on server
  uses: appleboy/ssh-action@v1.1.0
  with:
    host: ${{ secrets.SERVER_HOST }}
    username: ${{ secrets.SERVER_USER }}
    key: ${{ secrets.SSH_PRIVATE_KEY }}
    script: |
      set -e
      echo "ğŸš€ Iniciando despliegue con Nginx reverse proxy..."

      cd /root/app

      # Verificar que el archivo existe
      if [ ! -f "deployment.tar.gz" ]; then
        echo "âŒ ERROR: deployment.tar.gz no encontrado"
        echo "ğŸ“ Contenido actual:"
        ls -la
        exit 1
      fi

      echo "ğŸ“¦ Extrayendo archivos..."
      tar -xzf deployment.tar.gz --overwrite

      echo "ğŸ“„ Archivos extraÃ­dos:"
      ls -la

      # Verificar archivos esenciales
      if [ ! -d "dist" ]; then
        echo "âŒ ERROR: No se encontrÃ³ directorio dist/"
        exit 1
      fi

      if [ ! -f "Dockerfile" ]; then
        echo "âŒ ERROR: No se encontrÃ³ Dockerfile"
        exit 1
      fi

      echo "ğŸ³ Construyendo imagen Docker..."
      docker build -t vue-frontend .

      echo "ğŸ¯ Iniciando contenedor en puerto interno..."
      docker stop frontend 2>/dev/null || true
      docker rm frontend 2>/dev/null || true

      # Ejecutar contenedor en una sola lÃ­nea para evitar problemas
      docker run -d -p 3000:80 --name frontend --restart unless-stopped vue-frontend

      echo "ğŸ”§ Configurando Nginx como reverse proxy..."

      # Instalar nginx si no estÃ¡ instalado
      if ! command -v nginx &> /dev/null; then
        echo "ğŸ“¥ Instalando Nginx..."
        apt update && apt install -y nginx
      fi

      # Detener nginx temporalmente para configurar
      systemctl stop nginx 2>/dev/null || true

      # Crear configuraciÃ³n Nginx para el frontend
      cat > /etc/nginx/sites-available/voyager << 'EOF'
      server {
          listen 80;
          server_name voyager.andrescortes.dev;
          
          # Frontend Vue.js - sirve la aplicaciÃ³n
          location / {
              proxy_pass http://localhost:3000;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
              
              # Configuraciones adicionales para SPA
              try_files $uri $uri/ /index.html;
          }
          
          # Backend API - redirige las llamadas API a tu backend existente
          location /api/ {
              proxy_pass http://localhost:80;  # Tu backend actual en puerto 80
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
              
              # Configuraciones especÃ­ficas para API
              proxy_set_header X-Forwarded-Host $host;
              proxy_set_header X-Forwarded-Server $host;
          }
          
          # Archivos estÃ¡ticos - mejora el performance
          location /assets/ {
              proxy_pass http://localhost:3000;
              expires 1y;
              add_header Cache-Control "public, immutable";
          }
      }
      EOF

      # Remover configuraciÃ³n por defecto y activar nuestra configuraciÃ³n
      rm -f /etc/nginx/sites-enabled/default
      ln -sf /etc/nginx/sites-available/voyager /etc/nginx/sites-enabled/

      # Testear configuraciÃ³n Nginx
      echo "ğŸ§ª Verificando configuraciÃ³n Nginx..."
      nginx -t

      # Iniciar/reiniciar nginx
      echo "ğŸ”„ Iniciando Nginx..."
      systemctl start nginx 2>/dev/null || true
      systemctl enable nginx 2>/dev/null || true
      systemctl reload nginx 2>/dev/null || true

      # Configurar firewall para permitir trÃ¡fico
      echo "ğŸ”¥ Configurando firewall..."
      ufw allow 80/tcp 2>/dev/null || true
      ufw allow 443/tcp 2>/dev/null || true

      # Verificar que todo estÃ¡ funcionando
      echo "ğŸ” Verificando despliegue..."
      sleep 5
      echo "ğŸ³ Contenedores activos:"
      docker ps
      echo "ğŸŒ Nginx status:"
      systemctl status nginx --no-pager || echo "Nginx no estÃ¡ corriendo"

      # Limpieza
      rm -f deployment.tar.gz
      docker system prune -f

      echo "âœ… Â¡Despliegue exitoso con Nginx!"
      echo "ğŸŒ Frontend disponible en: https://voyager.andrescortes.dev"
      echo "ğŸ”§ API disponible en: https://voyager.andrescortes.dev/api/"
      echo "ğŸ“Š Logs del frontend: docker logs frontend"
      echo "ğŸ“Š Logs de Nginx: journalctl -u nginx -f"
